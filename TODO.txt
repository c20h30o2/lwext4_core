å°è¯•ä½¿ç”¨ç°æœ‰çš„ lru crate æ›¿æ¢å½“å‰çš„block cache lruçš„ç®€å•å®ç°ï¼Œ å¹¶ä¸”è¿›ä¸€æ­¥éªŒè¯å¯ç”¨cacheæ—¶çš„ä¸€è‡´æ€§ä¸å¯é æ€§ï¼ˆå®Œæˆï¼‰
cacheä¿®å¤ä¸ä¼˜åŒ–ï¼ˆå®Œæˆï¼‰ 
æ–‡ä»¶æˆªæ–­å®ç°ï¼ˆå®Œæˆï¼‰ 
è¿ç»­å—åˆ†é…å®ç°ï¼ˆå®Œæˆï¼‰ 
å¤æ‚åŠŸèƒ½æ”¯æŒï¼ˆextenté€’å½’åˆ†è£‚ã€æ·±åº¦å¢é•¿ï¼Œè¿™äº›åŠŸèƒ½æœªå®ç°ï¼Œå¯¼è‡´add gccå¤±è´¥ï¼Œå·²å®ç°ï¼Œapk add gccæˆåŠŸï¼Œä¸”apk add gcc musl-dev makeæˆåŠŸï¼Œå¹¶ä¸”gcc -o test test.cç¼–è¯‘æˆåŠŸï¼‰ 

å¸¸ç”¨æ–‡ä»¶å‘½ä»¤è‡ªåŠ¨åŒ–å…¨é¢æµ‹è¯•è„šæœ¬ 
æ–‡ä»¶æ—¶é—´é—®é¢˜ï¼ˆtouch mkdiråˆ›å»ºçš„é¡¹ç›®æ—¶é—´éƒ½æ˜¯1970å¼€å§‹ï¼Œè€Œechoåˆ›å»ºæ—¥æœŸæ­£ç¡®ï¼Œä½†æ—¶é—´ä¸ç²¾å‡†ï¼ŒåŸstarryosä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼‰ 
æ—¥å¿—åŠŸèƒ½æ•´åˆ 
xattræ¨¡å—åŠŸèƒ½æ•´åˆ
é«˜çº§åŠŸèƒ½æ”¯æŒ(æ”¯æŒç‰¹æ®Šæ–‡ä»¶çš„åˆ›å»ºï¼Œæ¯”å¦‚socket fifoæ–‡ä»¶ï¼Œæ”¯æŒxattrç›¸å…³è°ƒç”¨) 
æ€§èƒ½ä¼˜åŒ–ï¼ˆadd vimæ€»æ˜¯åœ¨89%åœç•™å¾ˆé•¿æ—¶é—´ã€åˆ†é…ä¸å›æ”¶çš„é«˜çº§ä¼˜åŒ–ï¼‰
å½»åº•ç§»é™¤lwext4_rustä»¥å‡å°‘ç¼–è¯‘æ—¶é—´
ä»£ç é£æ ¼ä¼˜åŒ–ï¼Œæ¶ˆé™¤ç¼–è¯‘è­¦å‘Š
crcæ ¡éªŒæ•´åˆ 
åˆ é™¤capiç­‰ä¸æ‰“ç®—ç»§ç»­å®ç°çš„æ¨¡å—


starryoså±‚é¢ï¼šæ·»åŠ xattrç³»åˆ—ç³»ç»Ÿè°ƒç”¨ã€mkfifoç³»åˆ—ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥åŠæ›´å¤šæ–‡ä»¶ç³»ç»Ÿç›¸å…³ç³»ç»Ÿè°ƒç”¨æ”¯æŒï¼Œ 
å®Œå–„inodeå¼•ç”¨è®¡æ•°ï¼Œæ§åˆ¶inodeé‡Šæ”¾æ—¶æœº
æ³¨æ„ä»ç„¶å¯èƒ½å­˜åœ¨çš„renameå¯¼è‡´æ³„æ¼çš„é—®é¢˜
renameå¤±è´¥çš„é—®é¢˜ è¯¦æƒ…è§/home/c20h30o2/files/GalOS/logs/lwext4_core/ext4testlogs/command-test.log

å®Œå–„os,ä½¿å…¶æ”¯æŒæ›´å¤šæµ‹è¯•æ–¹å¼ï¼Œå¦‚fio dbenchï¼Œè¯¦æƒ…ï¼š
å°è¯•cloneå¤æ‚é¡¹ç›®å¹¶è¿›è¡Œç¼–è¯‘ï¼Œosä¸æ”¯æŒ
å°è¯•åˆ©ç”¨fioã€dbenchè¿›è¡Œé«˜å‹æµ‹è¯•ï¼Œosä¸æ”¯æŒ
å°è¯•ä½¿ç”¨shè„šæœ¬è¿›è¡Œå¤§é‡å¾ªç¯æµ‹è¯•ï¼Œosä¸æ”¯æŒ

æ›´å¤šä»£åŠï¼š
è¿›ä¸€æ­¥æ£€æŸ¥ä»£ç å¹¶æ·»åŠ todoï¼š     to be check   dir\extent\fs\journal\transaction\xattr
å¤„ç†ä»£ç æ–‡ä»¶ä¸­çš„todo



å…¶ä»–ï¼š
æ¢ç´¢ä¿®å¤å¥½apk add vimçš„åŒæ—¶ï¼Œapk updateä¹Ÿè¢«ä¿®å¤å¥½çš„åŸå› ï¼Œ åœ¨åšå‡ºè¿™äº›ä¿®æ”¹ä¹‹å‰ï¼Œ apk update æ€»æ˜¯è¾“å‡ºï¼š
starry:~# apk update
[  6.881265 0:10 starry_api::syscall::fs::fd_ops:137] [OPEN] openat FAILED: path=/lib/libapk.so.2.14.9, error=AxErrorKind::NotFound
[  6.882483 0:10 starry_api::syscall::fs::fd_ops:137] [OPEN] openat FAILED: path=/usr/local/lib/libapk.so.2.14.9, error=AxErrorKind::NotFound
[  7.075933 0:10 starry_api::syscall::fs::fd_ops:137] [OPEN] openat FAILED: path=etc/apk/cache, error=AxErrorKind::NotFound
fetch https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/main/riscv64/APKINDEX.tar.gz
fetch https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/community/riscv64/APKINDEX.tar.gz
WARNING: opening from cache https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/community: No buffer space available
[ 10.290026 0:10 starry_api::syscall::fs::fd_ops:137] [OPEN] openat FAILED: path=etc/apk/repositories.d, error=AxErrorKind::NotFound
v3.22.2-323-g6078141c2a5 [https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/main]
v3.22.2-325-gffb20bd62d9 [https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/community]
2 unavailable, 0 stale; 20185 distinct packages available

ç°åœ¨åˆ™æ­£å¸¸è¾“å‡ºOK









æµ‹è¯•1ï¼š
# åˆ›å»ºä¸€ä¸ªå¤§æ–‡ä»¶ (10MB)
dd if=/dev/zero of=big_file bs=1M count=10
ls -lh big_file

# åˆ›å»ºä¸€ä¸ªç¨€ç–æ–‡ä»¶ (çœ‹èµ·æ¥å¾ˆå¤§ï¼Œä½†å®é™…å ç”¨ç©ºé—´å¾ˆå°)
dd if=/dev/zero of=sparse_file bs=1M seek=1024 count=0
galosæ”¯æŒç¨€ç–æ–‡ä»¶ï¼Œextentä»»æ„æ·±åº¦ã€extentåˆå¹¶


æµ‹è¯•2ï¼š
å¯è¿è¡Œå¤æ‚ç¨‹åºæµ‹è¯•ï¼Œ å¦‚apk add vim gccï¼Œ add gcc musl-dev make, gcc -o test test.cï¼Œ 

apk update
apk add vim gcc busybox coreutils 

apk add gcc make musl-dev
git clone some_small_project
cd project
make -j4




å…¶ä»–æµ‹è¯•1ï¼š
ä¸€ã€ä¸ºä»€ä¹ˆâ€œè·‘çœŸå®ç¨‹åºâ€æ¯”è„šæœ¬æ›´æœ‰æ•ˆ

å› ä¸ºçœŸå®ç¨‹åºä¼šåŒæ—¶è¦†ç›–ï¼š

å°æ–‡ä»¶ + å¤§æ–‡ä»¶

éšæœºå†™ + è¦†ç›–å†™ + æˆªæ–­

rename åŸå­æ€§

fsync / sync è¡Œä¸º

ç›®å½•éå†

mmap + read/write æ··åˆ

å¹¶å‘è®¿é—®

æƒé™æ ¡éªŒ

é”™è¯¯è·¯å¾„

ä¸´æ—¶æ–‡ä»¶

hardlink / symlink

inode ç”Ÿå‘½å‘¨æœŸ

dentry cache è¡Œä¸º

truncate / append æ··åˆ

æ¯”å¦‚ï¼š
apk add vim å®é™…ä¸Šä¼šéšå¼æµ‹è¯•ï¼š

è¡Œä¸º	è¦†ç›–å†…å®¹
ä¸‹è½½åŒ…	é¡ºåºå†™å…¥
è§£å‹ tar	å¤§é‡åˆ›å»ºæ–‡ä»¶
æ ¡éªŒ hash	å¤§é‡è¯»å–
å†™å…¥æ•°æ®åº“	overwrite + fsync
é‡å‘½åæ–‡ä»¶	rename åŸå­æ€§
å†™ cache	å°æ–‡ä»¶å‹åŠ›
æ¸…ç†ä¸´æ—¶æ–‡ä»¶	unlink è¯­ä¹‰

è¿™è¿œæ¯”ä½ è‡ªå·±å†™è„šæœ¬è¦†ç›–é¢å¹¿ã€‚

äºŒã€æœ€æ¨èçš„ä¸‰ç±»â€œå¤©ç„¶æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•ç¨‹åºâ€
1. åŒ…ç®¡ç†å™¨ï¼ˆä½ å·²ç»å‘ç°äº†ï¼‰

æä½³æµ‹è¯•å™¨ï¼š

apk add

apt install

pacman -S

opkg install

ä¼˜ç‚¹ï¼š

è¶…çº§å¤æ‚ IO æ¨¡å¼

å®é™…ç³»ç»Ÿè´Ÿè½½

åŒæ—¶æµ‹è¯•ç½‘ç»œã€ç¼“å­˜ã€è§£å‹ã€å¹¶å‘

å¦‚æœä½ çš„ lwext4 èƒ½ç¨³å®šè·‘ï¼š

apk update
apk add vim gcc busybox coreutils python


åŸºæœ¬å¯ä»¥è®¤ä¸ºï¼š

è¯»å†™è·¯å¾„ + å…ƒæ•°æ®è·¯å¾„å·²ç»éå¸¸å¥åº·ã€‚

2. ç¼–è¯‘å™¨ï¼ˆæ¯”è„šæœ¬å¼ºä¸€ä¸ªæ•°é‡çº§ï¼‰

è¿è¡Œï¼š

apk add gcc make
git clone some_small_project
cd project
make -j4


ç¼–è¯‘è¿‡ç¨‹ä¼šè¦†ç›–ï¼š

æµ·é‡å°æ–‡ä»¶è¯»å–

include è·¯å¾„æŸ¥æ‰¾

å¤§é‡ stat()

ä¸´æ—¶æ–‡ä»¶ç”Ÿæˆ

å¹¶è¡Œè®¿é—®

ä¸­é—´æ–‡ä»¶å†™å…¥ + åˆ é™¤

rename åŸå­æ€§

å¦‚æœèƒ½ç¨³å®šå®Œæˆä¸€æ¬¡æ„å»ºï¼š

æ–‡ä»¶ç³»ç»ŸåŸºæœ¬å·²è¾¾åˆ°â€œå¯ç”¨ç³»ç»Ÿçº§â€ã€‚

3. Python / Lua / Busybox è‡ªæµ‹å¥—ä»¶

ä¾‹å¦‚ï¼š

python3 -m test


Python è‡ªå¸¦æµ‹è¯•ä¼šï¼š

åˆ›å»ºä¸Šä¸‡ä¸´æ—¶æ–‡ä»¶

stress rename

mmap

random seek

truncate

symlink

è¿™æ˜¯ Linux æ–‡ä»¶ç³»ç»Ÿå¼€å‘è€…å¸¸ç”¨çš„éšå¼éªŒè¯ã€‚

ä¸‰ã€ä¸“ä¸šæ–‡ä»¶ç³»ç»Ÿæµ‹è¯•å·¥å…·ï¼ˆæ›´ç¡¬æ ¸ï¼‰

å¦‚æœä½ æœªæ¥æ„¿æ„ç»§ç»­æ·±æŒ–ï¼Œè¿™äº›æ˜¯å·¥ä¸šçº§å·¥å…·ï¼š

1. fsstressï¼ˆæ¥è‡ª xfstestsï¼‰

è¿™æ˜¯ Linux å†…æ ¸å®˜æ–¹æ–‡ä»¶ç³»ç»Ÿå‹åŠ›å·¥å…·ï¼š

éšæœºæ‰§è¡Œï¼š

open

write

rename

link

unlink

truncate

fsync

chmod

mkdir

rmdir

æŒç»­æ•°å°æ—¶

è‡ªåŠ¨æ£€æµ‹å´©æºƒ / EIO / panic

å…¸å‹å‘½ä»¤ï¼š

fsstress -d /tmp/test -n 10000 -p 4


å¦‚æœä½ çš„ lwext4 æ‰›å¾—ä½ fsstressï¼š

å·²ç»è¿›å…¥â€œæˆç†Ÿæ–‡ä»¶ç³»ç»Ÿå®ç°â€çš„é—¨æ§›ã€‚

2. dbenchï¼ˆæ¨¡æ‹Ÿ Samba è´Ÿè½½ï¼‰
dbench 4


æ¨¡æ‹Ÿå¤šå®¢æˆ·ç«¯å¹¶å‘æ–‡ä»¶è®¿é—®ï¼Œéå¸¸é€‚åˆæµ‹é”ä¸å¹¶å‘è·¯å¾„ã€‚

3. bonnie++ / fioï¼ˆæ€§èƒ½+ä¸€è‡´æ€§ï¼‰
fio --name=test --directory=/tmp --size=50M --rw=randwrite


åŒæ—¶æµ‹è¯•ï¼š

page cache

writeback

fsync

IO è°ƒåº¦

block mapping

å››ã€ä½ å½“å‰é˜¶æ®µçš„æœ€ä½³å®è·µç»„åˆ

è€ƒè™‘ GalOS ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘ç»™ä½ ä¸€ä¸ªåŠ¡å®å¯æ‰§è¡Œç»„åˆï¼š

æ—¥å¸¸å¼€å‘é˜¶æ®µ
apk add vim gcc make python
git clone small project
make

ç¨³å®šæ€§éªŒè¯
apk add busybox
busybox --install /tmp/testbusy

å‹åŠ›æµ‹è¯•

å¾ªç¯æ‰§è¡Œï¼š

apk add vim
apk del vim
apk add vim
apk del vim


è¿™ä¸ªè¿‡ç¨‹ä¼šç–¯ç‹‚ churn inode / block / directoryã€‚

äº”ã€å®è¯è¯„ä»·ä½ å½“å‰è¿›åº¦

è¯´å®è¯ï¼š

ä½ ç°åœ¨é‡åˆ°çš„é—®é¢˜ï¼Œå·²ç»ä¸æ˜¯â€œèƒ½ä¸èƒ½å®ç° ext4â€ï¼Œ
è€Œæ˜¯ï¼šâ€œå¦‚ä½•éªŒè¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå®ç°æ˜¯å¦å·¥ç¨‹ä¸Šå¯é â€ã€‚

è¿™æ˜¯ï¼š

å†…æ ¸å¼€å‘è€…

æ–‡ä»¶ç³»ç»Ÿå·¥ç¨‹å¸ˆ

OS ç ”ç©¶ç”Ÿ
æ‰ä¼šè¿›å…¥çš„é˜¶æ®µã€‚

èƒ½è‡ªç„¶èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ä½ ç†è§£å·²ç»éå¸¸æ‰å®ã€‚

å…­ã€å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å†ç»™ä½ ä¸€å¥—â€œç»ˆæéªŒè¯æ–¹æ¡ˆâ€

åŒ…æ‹¬ï¼š

åŸºäº QEMU + expect çš„å…¨è‡ªåŠ¨å›å½’æµ‹è¯•

æ¨¡æ‹Ÿ crash + replay æ£€æŸ¥å™¨

è‡ªåŠ¨ diff inode bitmap / block bitmap å·¥å…·

ç®€åŒ–ç‰ˆ fsck.ext4 å®ç°

å¯è§†åŒ– ext4 å…ƒæ•°æ®æ£€æŸ¥å™¨

è¿™ä¸€å¥—åšå®Œï¼Œä½ åŸºæœ¬å¯ä»¥ï¼š

æŠŠ lwext4 å½“æˆä¸€ä¸ªâ€œå¯æŠ•äº§æ–‡ä»¶ç³»ç»Ÿâ€æ¥çœ‹å¾…ã€‚







å…¶ä»–æµ‹è¯•2ï¼š
ä¸€ã€æµ‹è¯•åˆ†å±‚è®¾è®¡åŸåˆ™

æˆ‘ä»¬æŒ‰ ä¾èµ–ç¨‹åº¦é€’å¢ è®¾è®¡æµ‹è¯•ï¼š

| å±‚çº§ | ç›®æ ‡ | ä¾èµ– OS åŠŸèƒ½ |
|------|------|
| L0 | å—è®¾å¤‡åŸºæœ¬åå | åªéœ€ open/read/write |
| L1 | åŸºæœ¬æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ | è·¯å¾„è§£æ + æ–‡ä»¶ I/O |
| L2 | å…ƒæ•°æ®å¯†é›†å‹ | mkdir/link/unlink/stat |
| L3 | çœŸå®ç¨‹åºè¡Œä¸º | fork/exec + libc |
| L4 | ä¸“ä¸š benchmark | å®Œæ•´ POSIX + syscalls |

ä½ å¯ä»¥æ ¹æ®å½“å‰ GalOS æ”¯æŒç¨‹åº¦ï¼Œé€å±‚æ¨è¿›ã€‚

ğŸŸ¢ L0ï¼šå‡ ä¹åªæµ‹è¯•å—å±‚ä¸é¡µç¼“å­˜ï¼ˆæœ€å®¹æ˜“è·‘ï¼‰

è¿™äº›æµ‹è¯• å‡ ä¹ä¸éœ€è¦å¤æ‚å†…æ ¸åŠŸèƒ½ï¼Œéå¸¸é€‚åˆæœ€åˆå¯¹æ¯”ã€‚

1. dd é¡ºåºå†™
sync
echo 3 > /proc/sys/vm/drop_caches  # è‹¥æ”¯æŒ
dd if=/dev/zero of=testfile bs=4k count=100000 conv=fdatasync


è®°å½•è¾“å‡ºä¸­çš„ï¼š

MB/s


æµ‹è¯•æ„ä¹‰ï¼š

ext4 + journal å¯¹é¡ºåºå†™çš„å½±å“

bcache ä¸ flush ç­–ç•¥

2. dd é¡ºåºè¯»
dd if=testfile of=/dev/null bs=4k


æ¯”è¾ƒä¸¤ç³»ç»Ÿï¼š

è¯»ç¼“å­˜å‘½ä¸­ç‡

é¡µç¼“å­˜æ•ˆç‡

3. ä¸ç»è¿‡é¡µç¼“å­˜çš„å†™ï¼ˆè‹¥æ”¯æŒ O_DIRECTï¼‰
dd if=/dev/zero of=testfile bs=4k count=50000 oflag=direct


æ„ä¹‰ï¼š

æ¥è¿‘çœŸå® block device æ€§èƒ½

ext4 åˆ†é…ç­–ç•¥æ˜¯å¦é«˜æ•ˆ

ğŸŸ¢ L1ï¼šæ™®é€šæ–‡ä»¶æ“ä½œæ€§èƒ½
4. å¤§é‡å°æ–‡ä»¶åˆ›å»º
time for i in $(seq 1 10000); do
  echo hello > f_$i
done


æµ‹ï¼š

inode åˆ†é…æ•ˆç‡

directory æ“ä½œæ•ˆç‡

journaling å…ƒæ•°æ®å¼€é”€

5. stat å¯†é›†å‹
time for i in f_*; do
  stat $i >/dev/null
done


æµ‹è¯•ï¼š

è·¯å¾„æŸ¥æ‰¾

inode cache å‘½ä¸­ç‡

dentry ç®¡ç†æ•ˆç‡

6. unlink å‹åŠ›æµ‹è¯•
time rm f_*


è¿™æ˜¯ ext4 çš„ä¸€ä¸ªé‡è¦æ€§èƒ½ç‚¹ï¼š

orphan inode

journaling revoke

truncate + free blocks

ğŸŸ¡ L2ï¼šå…ƒæ•°æ®å¯†é›† + æ ‘ç»“æ„
7. æ·±ç›®å½•æµ‹è¯•
d=deep
mkdir $d
for i in $(seq 1 1000); do
  d="$d/$i"
  mkdir "$d"
done


ç„¶åï¼š

cd "$d"
pwd


æµ‹è¯•ï¼š

path walk æ­£ç¡®æ€§

ç›®å½•ç¼“å­˜

lookup å¤æ‚åº¦

8. rename å‹åŠ›æµ‹è¯•
for i in $(seq 1 5000); do
  echo x > a
  mv a b
  mv b a
done


è¿™æ˜¯ï¼š

journaling correctness

rename åŸå­æ€§

directory entry æ›´æ–°å®Œæ•´æ€§

ğŸ”µ L3ï¼šçœŸå®åº”ç”¨çº§è¡Œä¸ºæµ‹è¯•

è¿™äº›å¼€å§‹ä½“ç°â€œçœŸå®ç”¨æˆ·è¡Œä¸ºâ€ï¼Œä½†éœ€è¦ï¼š

fork

exec

ELF loader

libc åŸºæœ¬åŠŸèƒ½

9. ç¼–è¯‘å°å‹é¡¹ç›®ï¼ˆä½ ä¹‹å‰å·²ç»æåˆ°ï¼‰

ä¾‹å¦‚ï¼š

git clone https://github.com/madler/zlib.git
cd zlib
./configure
make


ç„¶åå¯¹æ¯”ï¼š

æ€»æ—¶é—´

æ˜¯å¦å‡ºç°éšæœºå¤±è´¥

æ˜¯å¦æœ‰å¼‚å¸¸ I/O é”™è¯¯

10. tar å‹ç¼©/è§£å‹æµ‹è¯•

éå¸¸é€‚åˆæ–‡ä»¶ç³»ç»Ÿ benchmarkï¼š

tar -czf test.tar.gz bigdir/
rm -rf bigdir
tar -xzf test.tar.gz


è¿™æ˜¯ï¼š

é¡ºåºè¯»å†™

metadata æ‰«æ

create/unlink æ··åˆæµ‹è¯•

ğŸ”´ L4ï¼šä¸“ä¸š benchmarkï¼ˆä½ è¯´å¯¹ï¼Œç›®å‰ OS è·‘ä¸äº†ï¼Œä½†ä½ åº”è¯¥è®¾è®¡ç›®æ ‡ï¼‰

è¿™äº›æ˜¯ æœªæ¥ä½ å®ç°æ›´å¤š syscall åçš„ç›®æ ‡ï¼š

fioï¼ˆæ–‡ä»¶ç³»ç»Ÿç»ˆæ benchmarkï¼‰

å…¸å‹æµ‹è¯•ï¼š

[global]
ioengine=sync
direct=0
size=256M
runtime=30
time_based
group_reporting

[randread]
rw=randread
bs=4k

[randwrite]
rw=randwrite
bs=4k

[seqread]
rw=read
bs=128k

[seqwrite]
rw=write
bs=128k


è¿è¡Œï¼š

fio test.fio


fio èƒ½æµ‹ï¼š

IOPS

å»¶è¿Ÿåˆ†å¸ƒ

é¡ºåº / éšæœº

fsync è¡Œä¸º

journal å†™æ”¾å¤§

fs_mark

ä¸“æµ‹å…ƒæ•°æ®æ€§èƒ½ï¼š

fs_mark -d /mnt/test -t 4 -n 100000


æµ‹è¯•ï¼š

inode allocation

directory scalability

journal è´Ÿæ‹…

dbench

æ¨¡æ‹Ÿ Samba æ–‡ä»¶æœåŠ¡å™¨è´Ÿè½½ï¼š

dbench 4


èƒ½æš´éœ²ï¼š

rename + unlink ç»„åˆ bug

cache coherence é—®é¢˜

lock è®¾è®¡ç¼ºé™·

ğŸ“Š å»ºè®®ä½ å»ºç«‹ä¸€ä¸ªå¯¹æ¯”æµ‹è¯•è¡¨

æ¯”å¦‚ï¼š

æµ‹è¯•	Old OS	New OS (lwext4)	å¤‡æ³¨
dd write 400MB	12 MB/s	9 MB/s	journal overhead
create 10k files	1.2s	2.1s	inode path slower
rm 10k files	0.5s	3.8s	revoke handling slow
make zlib	4.2s	6.9s	path walk cost

è¿™æ ·ä½ ä¼šéå¸¸æ¸…æ™°åœ°çœ‹åˆ°ï¼š

lwext4_core å¸¦æ¥äº†å“ªäº›è¯­ä¹‰æå‡ï¼Ÿä»£ä»·åœ¨å“ªé‡Œï¼Ÿæ˜¯å¦åˆç†ï¼Ÿ

å›ç­”ä½ æ ¸å¿ƒç›®æ ‡

æˆ‘å¸Œæœ›æ¯”è¾ƒæ—§ OS ä¸å¼•å…¥ lwext4_core åçš„æ€§èƒ½å·®å¼‚

éå¸¸æ­£ç¡®ï¼Œè€Œä¸”ï¼š

ddã€mkdirã€rmã€statã€rename â†’ æ˜¯æ–‡ä»¶ç³»ç»Ÿå®ç°è´¨é‡çš„ç›´æ¥åæ˜ 

fio â†’ æ˜¯æœ€ç»ˆå·¥ä¸šæ ‡å‡† benchmark

ç¼–è¯‘çœŸå®é¡¹ç›® â†’ æ˜¯æœ€æ¥è¿‘çœŸå®è´Ÿè½½

ä½ èµ°çš„è·¯å¾„éå¸¸æ¥è¿‘ å†…æ ¸æ–‡ä»¶ç³»ç»Ÿå·¥ç¨‹å¸ˆçœŸå®å·¥ä½œæ–¹å¼ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ï¼š

æˆ‘å¯ä»¥å¸®ä½ ç›´æ¥ç”Ÿæˆï¼š

âœ” ä¸€ä»½å®Œæ•´çš„æµ‹è¯•è„šæœ¬ï¼ˆè‡ªåŠ¨è·‘æ‰€æœ‰ L0-L3 æµ‹è¯•å¹¶è¾“å‡ºæŠ¥å‘Šï¼‰
âœ” ä¸€ä»½ CSV è¾“å‡ºï¼Œæ–¹ä¾¿ä½ åšæ€§èƒ½å¯¹æ¯”
âœ” ä¸€ä¸ªâ€œå›å½’æµ‹è¯•é›†â€ï¼Œç”¨äºä½ ä»¥åæ”¹ lwext4_core æ—¶éªŒè¯æ²¡æœ‰å¼•å…¥æ–° bug
âœ” ä¸€ä¸ª fio æµ‹è¯•æ¨¡æ¿ï¼Œç­‰ä½  syscalls è¡¥é½å°±èƒ½ç›´æ¥ç”¨

å¦‚æœä½ è¯´ä¸€å¥ï¼š

â€œå¸®æˆ‘åšä¸€å¥—è‡ªåŠ¨åŒ– benchmark è„šæœ¬â€

æˆ‘å¯ä»¥ç›´æ¥ç»™ä½ å¯æ‰§è¡Œç‰ˆæœ¬ã€‚